{% extends "base_wastd.html" %}
{% load leaflet_tags %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'tagging:turtleobservation_list' %}">Turtle observations</a></li>
        <li class="breadcrumb-item active">{{ object.pk }}</li>
    </ol>
</nav>
{% endblock %}

{% block page_content_inner %}
<div class="row">
    <div class="col">
        <h2>Turtle observation ID {{ object.pk }}</h2>
        <p>
        <span class="badge badge-{{ object.curation_status_colour|default:'secondary' }}">
            Curation status: {{ object.get_curation_status_display }}
        </span>
        </p>
    </div>
    <!-- FIXME: proper permissions check -->
    {% if user.is_staff %}
    <div class="col-xs-12 col-sm-6">
        <span class="float-right">
            <a class="btn btn-primary" href="{% url 'admin:tagging_turtleobservation_change' object_id=object.pk %}">
                <i class="fa-solid fa-pencil"></i>
                Change observation details
            </a>
        </span>
    </div>
    {% endif %}
</div>

<div class="row">
    <div class="col-sm-12 col-md-6">
        <table class="table table-striped table-bordered table-sm">
            <tbody>
                <tr>
                    <th>Observed</th>
                    <td>{{ object.observed|date:"D, j M Y H:i" }}</td>
                </tr>
                <tr>
                    <th>Turtle</th>
                    <td><a href="{{ object.turtle.get_absolute_url }}">{{ object.turtle }}</a></td>
                </tr>
                <tr>
                    <th>Recorded by</th>
                    <td>{{ object.recorded_by.name|default_if_none:"" }}</td>
                </tr>
                <tr>
                    <th>Tagged by</th>
                    <td>{{ object.tagger.name|default_if_none:"" }}</td>
                </tr>
                <tr>
                    <th>Tags recorded by</th>
                    <td>{{ object.tagger_reporter.name|default_if_none:"" }}</td>
                </tr>
                <tr>
                    <th>Measured by</th>
                    <td>{{ object.measurer.name|default_if_none:"" }}</td>
                </tr>
                <tr>
                    <th>Measurements recorded by</th>
                    <td>{{ object.measurer_reporter.name|default_if_none:"" }}</td>
                </tr>
                {% comment %}
                <tr>
                    <th>Action taken</th>
                    <td>{{ object.action_taken|default_if_none:"" }}</td>
                </tr>
                {% endcomment %}
                <tr>
                    <th>Comments</th>
                    <td>{{ object.comments|default_if_none:"" }}</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="col-sm-12 col-md-6">
        <table class="table table-striped table-bordered table-sm">
            <tbody>
                <tr>
                    <th>Alive?</th>
                    <td>{{ object.alive|yesno:"Yes,No,Unknown" }}</td>
                </tr>
                <tr>
                    <th>Nesting?</th>
                    <td>{{ object.nest|yesno:"Yes,No,Unknown" }}</td>
                </tr>
                <tr>
                    <th>Clutch completed?</th>
                    <td>{{ object.get_clutch_completed_display|default_if_none:"" }}</td>
                </tr>
                <tr>
                    <th>No. of eggs</th>
                    <td>{{ object.number_of_eggs|default_if_none:"" }}</td>
                </tr>
                <tr>
                    <th>Egg count method</th>
                    <td>{{ object.get_egg_count_method_display|default_if_none:"" }}</td>
                </tr>
                <tr>
                    <th>Place</th>
                    <td>{{ object.place.name|default_if_none:"" }}</td>
                </tr>
                <tr>
                    <th>Place description</th>
                    <td>{{ object.place_description|default_if_none:"" }}</td>
                </tr>
                <tr>
                    <th>Activity</th>
                    <td>{{ object.get_activity_display|default_if_none:"" }}</td>
                </tr>
                <tr>
                    <th>Beach position</th>
                    <td>{{ object.beach_position_code.description|default_if_none:"" }}</td>
                </tr>
                {% comment %}
                <tr>
                    <th>Condition</th>
                    <td>{{ object.get_condition_display|default_if_none:"" }}</td>
                </tr>
                {% endcomment %}
            </tbody>
        </table>
    </div>
</div>

<div class="row">
    <div class="col">
        <h3>Flipper tag observations</h3>
        {% if object.tag_observations.exists %}
        <table class="table table-striped table-bordered table-sm">
            <tbody>
                <tr>
                    <th>Tag</th>
                    <th>Position</th>
                    <th>Status</th>
                    <th>Barnacles?</th>
                    <th>Comments</th>
                </tr>
                {% for obs in object.tag_observations.all %}
                <tr>
                    <td>{{ obs.tag }}</td>
                    <td>{{ obs.position|default_if_none:"" }}</td>
                    <td>{{ obs.get_status_display|default_if_none:"" }}</td>
                    <td>{{ obs.barnacles|yesno:"Yes,No,Unknown" }}</td>
                    <td>{{ obs.comments|default_if_none:"" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>Not recorded.</p>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col">
        <h3>Pit tag observations</h3>
        {% if object.pit_tag_observations.exists %}
        <table class="table table-striped table-bordered table-sm">
            <tbody>
                <tr>
                    <th>Tag</th>
                    <th>Status</th>
                    <th>Comments</th>
                </tr>
                {% for obs in object.pit_tag_observations.all %}
                <tr>
                    <td>{{ obs.tag }}</td>
                    <td>{{ obs.get_status_display|default_if_none:"" }}</td>
                    <td>{{ obs.comments|default_if_none:"" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>Not recorded.</p>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col">
        <h3>Measurements</h3>
        {% if object.turtlemeasurement_set.exists %}
        <table class="table table-striped table-bordered table-sm">
            <tbody>
                <tr>
                    <th>Measurement</th>
                    <th>Value</th>
                    <th>Comments</th>
                </tr>
                {% for measure in object.turtlemeasurement_set.all %}
                <tr>
                    <td>{{ measure.measurement_type }}</td>
                    <td>{{ measure }}</td>
                    <td>{{ measure.comments|default_if_none:"" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>Not recorded.</p>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-sm-12 col-md-6">
        <h3>Nesting</h3>
        <table class="table table-striped table-bordered table-sm">
            <tbody>
                <tr>
                    <th>Did the turtle lay?</th>
                    <td>{{ object.get_nested_display }}</td>
                </tr>
                <tr>
                    <th>Egg count</th>
                    <td>{{ object.number_of_eggs|default_if_none:"" }}</td>
                </tr>
                <tr>
                    <th>Was the nesting process interrupted?</th>
                    <td>{{ object.nesting_interrupted|yesno:"Yes,No" }}</td>
                </tr>
                <tr>
                    <th>Nesting interruption cause</th>
                    <td>{{ object.get_nesting_interruption_cause_display }}</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="row">
    <div class="col">
        <h3>Damage</h3>
        {% if object.damage.exists %}
        <table class="table table-striped table-bordered table-sm">
            <tbody>
                <tr>
                    <th>Damage</th>
                    <th>Comments</th>
                </tr>
                {% for damage in object.damage.all %}
                <tr>
                    <td>{{ damage }}</td>
                    <td>{{ damage.comments|default_if_none:"" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>Not recorded.</p>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col">
        <h3>Scars</h3>
        {#<p>Tag scars not checked: {{ object.tagscarnotchecked|yesno:"Yes,No,Unknown" }}</p>#}
        <table class="table table-striped table-bordered table-sm">
            <tbody>
                <tr>
                    <td>Scars left scale 1: {{ object.scars_left_scale_1|yesno:"Yes,No,Unknown" }}</td>
                    <td>Scars right scale 1: {{ object.scars_right_scale_1|yesno:"Yes,No,Unknown" }}</td>
                </tr>
                <tr>
                    <td>Scars left scale 2: {{ object.scars_left_scale_2|yesno:"Yes,No,Unknown" }}</td>
                    <td>Scars right scale 2: {{ object.scars_right_scale_2|yesno:"Yes,No,Unknown" }}</td>
                </tr>
                <tr>
                    <td>Scars left scale 3: {{ object.scars_left_scale_3|yesno:"Yes,No,Unknown" }}</td>
                    <td>Scars right scale 3: {{ object.scars_right_scale_3|yesno:"Yes,No,Unknown" }}</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="row">
    <div class="col">
        <h3>Tissue samples</h3>
        {% if object.samples.exists %}
        <table class="table table-striped table-bordered table-sm">
            <tbody>
                <tr>
                    <th>Type</th>
                    <th>Label</th>
                </tr>
                {% for sample in object.samples.all %}
                <tr>
                    <td>{{ sample.get_tissue_type_display }}</td>
                    <td>{{ sample.label|default_if_none:"" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>Not recorded.</p>
        {% endif %}
    </div>
</div>

{% if observation_points %}
<div class="row">
    <div class="col">
        <h3>Location</h3>
        {% leaflet_map "detailmap" callback="window.map_init" %}
    </div>
</div>
{% endif %}<!-- observation_points -->

<div class="row">
    <div class="col">
        <div class="alert alert-secondary">
            <p>Input by: {{ object.entered_by.name|default_if_none:"" }}</p>
            <p>Date input: {{ object.created|date:"j-M-Y" }}</p>
        </div>
    </div>
</div>
{% endblock page_content_inner %}

{% block extra_js %}
{% if observation_points %}
{{ block.super }}
<script type="text/javascript">
function map_init(map, options) {
    {% include "shared/styles.js" %}
    function onEachFeature(feature, layer) {
        if (feature.properties && feature.properties.label) {
            layer.bindPopup(feature.properties.label);
        }
    };
    const obsFeatures = {{ observation_points|safe }};
    const obsLayer = L.geoJSON(obsFeatures, {onEachFeature: onEachFeature});
    obsLayer.addTo(map);
    map.fitBounds(obsLayer.getBounds());
};
</script>
{% endif %}
{% endblock extra_js %}
