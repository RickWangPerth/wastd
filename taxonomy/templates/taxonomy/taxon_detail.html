{% extends "base.html" %}
{% load staticfiles leaflet_tags geojson_tags mptt_tags taxonomy_tags occurrence_tags crispy_forms_tags bootstrap4 %}
{% load render_table from django_tables2 %}

{% block extrastyle %}
<style>
.leaflet-popup, .leaflet-popup-content-wrapper, .leaflet-popup-content {
  width: 350px; /* narrower popup */
  padding: -10px;  /* fix close button position */
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" id="wrap">

<!-- Breadcrumbs -->
  <div class="row" id="taxon-detail-breadcrumb">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item" aria-current="page">
          <a href="{% url 'taxon-list' %}">Species</a>
        </li>
        <li class="breadcrumb-item" aria-current="page">
          <a href="{% url 'taxon-list' %}?name_id={{ original.name_id }}"
          title="List {{ original.taxonomic_name }} with its parents and immediate children.">
            Taxonomy of {{ original }}</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
          <a href="{% url 'taxon-detail' original.name_id %}">{{ original }}</a>
        </li>
      </ol>
    </nav>
  </div><!-- /#taxon-detail-breadcrumb -->

  <div class="container-fluid">


    <div class="row">
    <!-- Taxon details -->
    <div class="col-12 col-sm-12 col-md-6 col-lg-8" id="taxon-detail-main">
    <div class="jumbotron">

      <p>
        <!-- Name ID -->
          <span class="badge badge-primary" title="WACensus Name ID: {{original.name_id}}">
            {{original.name_id}}
          </span>

          <!-- Rank -->
          <span class="badge badge-primary" title="Taxonomic rank: {{ original.get_rank_display }}">
            {{ original.get_rank_display }}
          </span>

          {% taxonomic_status %}

          <!-- Publication status -->
          {% if original.publication_status < 2 %}
          <span class="badge badge-secondary">
            {{ original.get_publication_status_display }}
          </span>
          {% endif %}

          <!-- Leaf nodes are terminal taxa -->
          {% if original.is_leaf_node %}
          <span class="badge badge-success">
            <span class="oi oi-media-stop" title="Terminal Taxon" aria-hidden="true"></span>
          </span>
          {% endif %}
      </p>

      <h1 class="display-4">
        {{ original.canonical_name }}
        {% if request.user.is_staff %}
        <small class="float-right">
          <a href="{% url 'admin:taxonomy_taxon_change' original.pk %}"
          class="btn btn-primary btn-sm"
          role="button"
          target="_"
          title="Edit Taxon details.">
            <span class="oi oi-pencil" aria-hidden="true"></span>
          </a>
      </small>
      {% endif %}
      </h1>

      <!-- Author -->
      {% if original.author %}
        <p class="lead">
        <span class="oi oi-person" title="Author" aria-hidden="true"></span>
        {{ original.author }}
        </p>
      {% endif %}

      <p class="lead">
        {% vernacular_names %}
      </p>

      <hr class="my-4">
      <h3>Conservation Listings
        <small class="float-right">
          {% taxongazettal_add request.user block=False show_label_text=False %}
        </small>
      </h3>
      <p>{% taxongazettal_rows request.user %}</p>

      <hr class="my-4">
      <h3>Documents
        <small class="float-right">
          {% document_add request.user "taxa" block=False show_label_text=False %}
        </small>
      </h3>
      <p>{% document_row request.user %}</p>

      <hr class="my-4">
      <p class="lead">
        {% if request.user.is_staff %}
        <a href="{% url 'admin:taxonomy_taxon_change' original.pk %}"
          class="btn btn-primary btn-sm"
          role="button"
          target="_"
          title="Edit Taxon details.">
            <span class="oi oi-pencil" aria-hidden="true"></span>
            Edit Taxon details
          </a>
          {% endif %}
          {% taxongazettal_add request.user block=False show_label_text=True %}
          {% document_add request.user "taxa" block=False show_label_text=True %}
          {% areaencounter_add request.user "taxon" block=False show_label_text=True %}
      </p>

    </div><!-- /.jumbotron -->
    </div><!-- /.col#taxon-detail-main -->

    <div class="col-12 col-md-6 col-lg-4" id="taxon-occ">
        <div id="map">
          {% leaflet_map "detailmap" callback="window.map_init" %}
        </div>
    </div><!-- /.col#taxon-occ -->

  </div><!-- /.row -->

  <!-- Taxon occurrence records -->
  <div class="row" id="occ-row">
    <div class="col-12" id="occ-main">
      <div class="jumbotron">
        <p class="lead">
        <h3>Occurrence records
          <small class="float-right">
            {% areaencounter_add request.user "taxon" block=False show_label_text=False %}
          </small>
        </h3>
        {% render_table occurrences %}
        </p>
      </div>
    </div>
  </div><!-- /#occ-row -->

  </div><!-- /.container-fluid -->
</div><!-- /.container-fluid#wrap -->
{% endblock %}

{% block javascript%}
{{ block.super }}
<script type="text/javascript">
/*
 * Workaround for 1px lines appearing in some browsers due to fractional transforms
 * and resulting anti-aliasing.
 * https://github.com/Leaflet/Leaflet/issues/3575
 */
(function(){
    // L.Icon.Default.imagePath = '/static/leaflet/images/';
    delete L.Icon.Default.prototype._getIconUrl

    L.Icon.Default.mergeOptions({
      iconRetinaUrl: "/static/leaflet/images/marker-icon-2x.png",
      iconUrl: "/static/leaflet/images/marker-icon.png",
      shadowUrl: "/static/leaflet/images/marker-shadow.png"
    })


    var originalInitTile = L.GridLayer.prototype._initTile
    L.GridLayer.include({
        _initTile: function (tile) {
            originalInitTile.call(this, tile);

            var tileSize = this.getTileSize();

            tile.style.width = tileSize.x + 1 + 'px';
            tile.style.height = tileSize.y + 1 + 'px';
        }
    });
})()

function map_init(map, options) {

    /* Point style */
    var pointstyle = {
        "clickable": true
    };

    /* Polygon style */
    var polystyle = {
        "color": "#0009ff",
        "weight": 1,
        "opacity": 0.65
    };

    /* Map a feature to an icon class */
    function getIcon(feature){
        if (feature.properties.leaflet_icon){
            return feature.properties.leaflet_icon
        } else {
            return "eye"
        }
    }

    /* Map a feature to an marker colour */
    function getMarkerColor(feature){
        if (feature.properties.leaflet_colour){
            return feature.properties.leaflet_colour
        } else {
            return "red"
        }
    }

    /* Use FontAwesome icons for Leafet.awesome-markers */
    L.AwesomeMarkers.Icon.prototype.options.prefix = 'fa';

    /* Return a grouping variable - using feature.id disables grouping */
    function getUnique(feature){return feature.id}

    /* Override default Marker, set colour, symbol; add mouse hover title */
    function ptl(feature, latlng) {
        /* https://github.com/lvoogdt/Leaflet.awesome-markers */
        var icon = new L.AwesomeMarkers.icon({
            icon: getIcon(feature),
            iconColor: "white",
            markerColor: getMarkerColor(feature),
            // prefix: 'fa',
            // spin:false
        });

        return L.marker(latlng, {icon: icon});
        //title: feature.properties.leaflet_title,
    }

    /* Actions taken on each feature: title, popup, info preview */
    function oef (feature, layer) {
        layer.bindTooltip("Extent of Occurrence");
        // layer.bindPopup("Extent of Occurrence");
    }

    function oef_rel (feature, layer) {
      layer.bindTooltip('TSC<br/><span class="oi oi-calendar" aria-hidden="true">' + feature.properties.encountered_on);
      layer.bindPopup(feature.properties.as_html);
    }

    /* Data loading */
    /*
     * Option 1: List view queryset plus djgeojson filter tag = GeoJSON
     * Ideal for filters with sensible defaults (e.g. show only current year)
     * https://github.com/makinacorpus/django-geojson#geojson-template-filter
     */
    var eoo = L.geoJson(
        {{ original|geojsonfeature:"canonical_name,taxonomic_name:eoo"|safe }},
        {style: pointstyle, onEachFeature: oef}
    );
    eoo.addTo(map);
    map.fitBounds(eoo.getBounds());

    L.geoJson(
        {{ original.taxon_occurrences.all|geojsonfeature:"label,as_html,encountered_on:geom"|safe }},
        {style: polystyle, onEachFeature: oef_rel}
    ).addTo(map);

    L.geoJson(
        {{ original.taxon_occurrences.all|geojsonfeature:"label,as_html,encountered_on:point"|safe }},
        {style: pointstyle, pointToLayer: ptl, onEachFeature: oef_rel}
    ).addTo(map);

    // var markers = L.markerClusterGroup();
    // var gj_markers = L.geoJson(
    //     {{ object_list|geojsonfeature:'as_html,leaflet_title,leaflet_icon,leaflet_colour:where'|safe }},
    //     // {clipTiles: true, unique: getUnique},
    //     {style: pointstyle, pointToLayer: ptl, onEachFeature: oef});
    // markers.addLayer(gj_markers);
    // map.addLayer(markers);

    /*
     * Option 2: GeoJSON view
     * The quick and dirty way to dump all (whoa) data into one layer
     * https://github.com/makinacorpus/django-geojson#geojson-layer-view
     * We'll use this method to load area polygons.
     */
    // $.getJSON("{% url 'areas-geojson' %}", function (data) {
    //     L.geoJson(data, {style: polystyle, onEachFeature: oef}).addTo(map);
    // });

    /*
     * Option 3: Tiled GeoJSON      ...because we can, baby
     * Most performant solution
     * https://github.com/glenrobertson/leaflet-tilelayer-geojson/
     * TODO filters or clustering
     * getUnique returns grouping variable (using feature.id disables grouping)
     * ptl overrides default marker with AwesomeMarker
     * oef binds popup to marker
     */
    // var geojsonTileLayer = new L.TileLayer.GeoJSON(
    //     'data/{z}/{x}/{y}.geojson',
    //     {clipTiles: true, unique: getUnique},
    //     {style: pointstyle, pointToLayer: ptl, onEachFeature: oef}
    // ).addTo(map);

    /*
     * BioSys Occurrences
     */
    // using Fetch API

    /* Override default Marker, set colour, symbol; add mouse hover title */
    function ptlBioSys(feature, latlng) {
        /* https://github.com/lvoogdt/Leaflet.awesome-markers */
        var icon = new L.AwesomeMarkers.icon({icon: 'database', markerColor: 'green'});
        return L.marker(latlng, {icon: icon});
    }

    function oefBioSys(feature, layer) {
      layer.bindPopup(
        '<div class="row"><div class="mr-auto p-2"><h5>'+ feature.properties.species_name + '</h5></div></div>' +
        '<p><i class="oi oi-calendar" aria-hidden="true"></i> ' + feature.properties.datetime + '</p>' +
        '<p><a class="btn btn-secondary btn-sm" target="_" ' +
        'href="https://biosys-uat.dbca.wa.gov.au/#/data/projects/61/datasets/' +
        feature.properties.dataset + '/record/' + feature.id + '">' +
        '<i class="oi oi-pencil"></i> Edit this record in BioSys</a></p>'
      );
      layer.bindTooltip('BioSys <br/><span class="oi oi-calendar" aria-hidden="true">' + feature.properties.datetime);
    }

    /* Turn a BioSys API record into a GeoJSON Feature. */
    function geoJSONify(json_record) {
      return {
        type: 'Feature',
        id: json_record.id,
        geometry: {type: 'Point', coordinates: json_record.geometry.coordinates},
        properties: json_record
      };
    }

    function geoJSONfc(gj_feature_array) {
      return {"type": "FeatureCollection", "features": gj_feature_array.map(geoJSONify)}
    }

    /* Authentication headers for BioSys API. */
    var hdr = new Headers();
    hdr.append("Authorization", 'Basic ' + btoa('{{ settings.BIOSYS_UN }}:{{ settings.BIOSYS_PW }}'));

    fetch(
      "{{ settings.BIOSYS_TSC_URL|safe }}{{ original.name_id }}", {credentials: "include", headers: hdr}
    ).then(
      function (response) {return response.json();}
    ).then(
      function(json) {
        var point_markers = L.geoJson(geoJSONfc(json), {pointToLayer: ptlBioSys, onEachFeature: oefBioSys});
        // console.log(geoJSONfc(json));
        var cluster_markers = L.markerClusterGroup();
        cluster_markers.addLayer(point_markers);
        map.addLayer(cluster_markers);
      }
    );
}
</script>
{% endblock %}
