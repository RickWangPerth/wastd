{% extends "base.html" %}
{% load leaflet_tags geojson_tags %}

{% block map %}
<div id="mapholder">
    {% leaflet_map "wastdmap" callback="window.map_init" %}
</div>
{% endblock map %}

{% block javascript%}
{{ block.super }}
<script type="text/javascript">


/* TODO Cluster markers: https://github.com/Leaflet/Leaflet.markercluster */

function map_init(map, options) {

    /* Helper functions */

    var style = {
        "clickable": true
    }

    /* Map a feature to an icon class */
    function getIcon(feature){
        if (feature.properties.leaflet_icon){
            return feature.properties.leaflet_icon
        } else {
            return "question-circle-o"
        }
    }

    /* Map a feature to an marker colour */
    function getMarkerColor(feature){
        if (feature.properties.leaflet_colour){
            return feature.properties.leaflet_colour
        } else {
            return "red"
        }
    }

    /* Use FontAwesome icons for Leafet.awesome-markers */
    L.AwesomeMarkers.Icon.prototype.options.prefix = 'fa';

    /* Return a grouping variable - using feature.id disables grouping */
    function getUnique(feature){return feature.id}

    /* Override default Marker, set colour, symbol; add mouse hover title */
    function ptl(feature, latlng) {
        /* https://github.com/lvoogdt/Leaflet.awesome-markers */
        var icon = new L.AwesomeMarkers.icon({
            icon: getIcon(feature),
            iconColor: 'white',
            markerColor: getMarkerColor(feature),
            // prefix: 'fa',
            // spin:false
        });

        return L.marker(
            latlng,
            {title: feature.properties.leaflet_title, icon: icon}
        );

    }

    function oef (feature, layer) {layer.bindPopup(feature.properties.as_html);}


    /* Data loading */

    /*
     * Option 1: List view queryset plus djgeojson filter tag = GeoJSON
     * Ideal for filters with sensible defaults (e.g. show only current year)
     * https://github.com/makinacorpus/django-geojson#geojson-template-filter
     */
    // L.geoJson({{ qs_results|geojsonfeature|safe }}).addTo(map);

    /*
     * Option 2: GeoJSON view
     * The quick and dirty way to dump all (whoa) data into one layer
     * https://github.com/makinacorpus/django-geojson#geojson-layer-view
     */
    // $.getJSON("{% url 'observation-geojson' %}", function (data) {
    //     L.geoJson(data, {
    //         style: function (feature) {return {};},
    //         onEachFeature: function (feature, layer) {
    //             layer.bindPopup(feature.properties.as_html)
    //         }
    //     }).addTo(map);
    //});

    /*
     * Option 3: Tiled GeoJSON because we can, baby
     * Most performant solution, needs filters or clustering
     * https://github.com/glenrobertson/leaflet-tilelayer-geojson/
     * getUnique returns grouping variable (using feature.id disables grouping)
     * ptl overrides default marker with AwesomeMarker
     * oef binds popup to marker
     */
    var geojsonTileLayer = new L.TileLayer.GeoJSON(
        'data/{z}/{x}/{y}.geojson',
        {clipTiles: true, unique: getUnique},
        {style: style, pointToLayer: ptl, onEachFeature: oef}
    ).addTo(map);

}
</script>
{% endblock %}
