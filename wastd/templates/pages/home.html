{% extends "base.html" %}
{% load leaflet_tags geojson_tags %}

{% block map %}
<div id="mapholder">
    {% leaflet_map "wastdmap" callback="window.map_init" %}
</div>
{% endblock map %}

{% block javascript%}
{{ block.super }}
<script type="text/javascript">


/* TODO Cluster markers: https://github.com/Leaflet/Leaflet.markercluster */

function map_init(map, options) {

    /* Helper functions */

    /* TODO resolve a colour based on text values */
    function getColor(d) {
        return d > 1000 ? '#800026' :
               d > 500  ? '#BD0026' :
               d > 200  ? '#E31A1C' :
               d > 100  ? '#FC4E2A' :
               d > 50   ? '#FD8D3C' :
               d > 20   ? '#FEB24C' :
               d > 10   ? '#FED976' :
                          '#FFEDA0';
    }

    /* Calculate a style dict from a feature */
    function style(feature) {
        return {
            //fillColor: getColor(feature.properties.name),
            "clickable": true,
            "fillColor": "#800026",
            "weight": 10.0,
            "opacity": 0.3,
            "fillOpacity": 0.2
        };
    }

    /* Map a feature to an icon class */
    function getIcon(feature){
        return 'exclamation-triangle'
        /* TODO switch on observation_type */
    }

    /* Map a feature to an marker colour */
    function getMarkerColor(feature){
        return "red"

        /* TODO switch on observation_type */
    }

    /* Use FontAwesome icons for Leafet.awesome-markers */
    L.AwesomeMarkers.Icon.prototype.options.prefix = 'fa';


    function getUnique(feature){
        return feature.id
    }

    function ptl(feature, latlng) {
        /* https://github.com/lvoogdt/Leaflet.awesome-markers */
        var icon = new L.AwesomeMarkers.icon({
            icon: getIcon(feature),
            iconColor: 'white',
            markerColor: getMarkerColor(feature),
            // prefix: 'fa',
            // spin:false
        });

        return L.marker(
            latlng, {
            zIndexOffset: 1000,
            title: feature.properties.leaflet_title,
            icon: icon,
        });

    }



    /* Data loading */

    /*
     * Option 1: List view queryset plus djgeojson filter tag = GeoJSON
     * Ideal for filters with sensible defaults (e.g. show only current year)
     * https://github.com/makinacorpus/django-geojson#geojson-template-filter
     */
    // L.geoJson({{ qs_results|geojsonfeature|safe }}).addTo(map);

    /*
     * Option 2: GeoJSON view
     * The quick and dirty way to dump all (whoa) data into one layer
     * https://github.com/makinacorpus/django-geojson#geojson-layer-view
     */
    // $.getJSON("{% url 'observation-geojson' %}", function (data) {
    //     L.geoJson(data, {
    //         style: function (feature) {return {};},
    //         onEachFeature: function (feature, layer) {
    //             layer.bindPopup(feature.properties.as_html)
    //         }
    //     }).addTo(map);
    //});

    /*
     * Option 3: Tiled GeoJSON because we can, baby
     * Most performant solution, needs filters or clustering
     * https://github.com/glenrobertson/leaflet-tilelayer-geojson/
     * The heavy lifting is outsourced to functions getUnique, style, onEachFeature
     */
    var geojsonTileLayer = new L.TileLayer.GeoJSON(
        'data/{z}/{x}/{y}.geojson',
        {clipTiles: true, unique: getUnique},
        {
            style: {},

            /* Override default marker with AwesomeMarker */
            pointToLayer: ptl,
            
            /* bind popup */
            onEachFeature: function (feature, layer) {
                layer.bindPopup(feature.properties.as_html);
            }
        }
    ).addTo(map);

}
</script>
{% endblock %}
